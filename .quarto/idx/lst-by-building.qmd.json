{"title":"What is Land Surface Temperature Building for a given site?","markdown":{"yaml":{"title":"What is Land Surface Temperature Building for a given site?","editor":"visual","editor_options":{"chunk_output_type":"console"}},"headingText":"Objective","containsRefs":false,"markdown":"\n\n```{r}\nlibrary(sf)\nlibrary(leaflet)\nlibrary(raster)\nlibrary(ggplot2)\nsource(\"R/postgis.R\")\n```\n\n\nCalculate Land Surface Temperature (LST) and assign to building and site. \n\n# Background\n\nThe resolution of satellites is 30m. This limits accuracy; however, mitigated \ntwo mitigating factors. One, military buildings are often close together, so observing clusters of small buildings. \nTwo, new satellites are coming online with more precise measurements so method has future applicability.\n\n# Method\n\n1. Define an Area of Interest \n2. Calculate LST\n3. Summarise by building polygon\n\n# Area of Interest (AOI)\n\nOur area of interst is centered on RAF Brize Norton and the town of Carterton.\n* North West: Solar Farm\n* North East: Village of Curbridge\n* South East: Village of Bampton\n* South West: Village of Filkins\n\n```{r}\n# http://bboxfinder.com/#51.722137,-1.664772,51.777665,-1.530704\n\nlng1 <- -1.664772\nlat1 <- 51.722137\nlng2 <- -1.530704\nlat2 <- 51.777665\n\nbbox <- st_bbox(c(xmin = lng1, xmax = lng2, ymin = lat1, ymax = lat2), crs = 4326)\nbbox <- bbox |> st_as_sfc()\n\nleaflet(options = leafletOptions(minZoom = 13, maxZoom = 18)) |>\n  addTiles() |>\n  fitBounds(lng1, lat1, lng2, lat2) |>\n  setMaxBounds(lng1, lat1, lng2, lat2) |>\n  addPolygons(data = bbox)\n\n```\n\n# Calculate LST for AOI\n\n```{r}\n\nd <- \"../../../OneDrive/Data/landstat/LC09_L2SP_202024_20220826_20220830_02_T1/\"\nf <- list.files(d)\nb4_tif <- file.path(d, f[grepl(\"B4\", f)])\nb5_tif <- file.path(d, f[grepl(\"B5\", f)])\nb10_tif <- file.path(d, f[grepl(\"B10\", f)])\nmeta <- file.path(d, f[grepl(\"MTL.txt\", f)])\n\n# https://downloads.hindawi.com/journals/js/2016/1480307.pdf\n# http://www.gisandbeers.com/GeoBazar/Libros/Teledeteccion/Manual-Landsat-9-Handbook.pdf\ncalculate_lst <- function(b4_tif, b5_tif, b10_tif, meta){\n  red = raster(b4_tif)\n  near.infrared = raster(b5_tif)\n  band_10 = raster(b10_tif)\n  meta <- readLines(meta)\n  \n  M_L <- meta[stringr::str_detect(meta, \"RADIANCE_MULT_BAND_10\")] |>\n    stringr::str_split(\" = \") |>\n    unlist() |>\n    dplyr::nth(2) |>\n    as.numeric()\n  \n  A_L <- meta[stringr::str_detect(meta, \"RADIANCE_ADD_BAND_10\")] |>\n    stringr::str_split(\" = \") |>\n    unlist() |>\n    dplyr::nth(2) |>\n    as.numeric()\n  \n  # Top of Atmosphere\n  toa <- M_L * band_10 + A_L\n  \n  K_1 <- meta[stringr::str_detect(meta, \"K1_CONSTANT_BAND_10\")] |>\n    stringr::str_split(\" = \") |>\n    unlist() |>\n    dplyr::nth(2) |>\n    as.numeric()\n  \n  K_2 <- meta[stringr::str_detect(meta, \"K2_CONSTANT_BAND_10\")] |>\n    stringr::str_split(\" = \") |>\n    unlist() |>\n    dplyr::nth(2) |>\n    as.numeric()\n  \n  # Convert to Brightness Temperature\n  BT <- (K_2 / (log(K_1/toa)+1))- 273.15 # kevin to celcius\n  \n  # Calculate NVDI\n  nvdi <- (near.infrared - red)/(near.infrared + red)\n\n  # Calculate Proportion Vegetation\n  nvdi_s <- 0.2\n  nvdi_v <- 0.5\n  p_v <- nvdi\n  p_v@data@values <- ((p_v@data@values - nvdi_s)/(nvdi_v-nvdi_s))^2\n  \n  \n  # Calcualte Emisivity\n  # If nvdi less than 0 then water and emissivity (e_w) is 0.991\n  # If nvdi < nvdi_s then emissivity (e_s) is 0.0996\n  # If nvdi > nvdi_v then emissivity (e_v) is 0.973\n  # if nvdi is between 0.2 and 0.5 then  e_v*P_V + e_s(1-P_V)+C_l\n  \n  e_w <- 0.991\n  e_s <- 0.996\n  e_v <- 0.973\n  C_l <- 0.005 # correction\n  \n  e <- p_v\n  e@data@values <- ifelse(\n    e@data@values <= 0, e_w, ifelse(\n      e@data@values >0 & e@data@values <= nvdi_s, e_s, ifelse(\n        e@data@values > nvdi_s & e@data@values <= nvdi_v, e_v * e@data@values + e_s * (1-e@data@values) + C_l, e_v\n        )\n    )\n  )\n  \n  lambda <- 10.895 # average limiting wavelength\n  rho <- 1.438 * 10e-2 # see paper\n  \n  # Calcualte LST\n  LST <- (BT / (1 + (0.0010895 * BT / 1.4388) * log(e)))\n}\n\nLST <- calculate_lst(b4_tif, b5_tif, b10_tif, meta)\n\nplot(LST)\n```\n\n# Remove Cloud and Water\n\n```{r}\nqa_lu <- readr::read_csv(\"data/qa_pixel.csv\")\nqa <- raster(file.path(d, f[grepl(\"QA_PIXEL.TIF\", f)]))\n\nmask_values <- qa_lu |>\n  dplyr::filter(Cloud == \"Yes\" | Water == \"Yes\") |>\n  dplyr::pull(`Pixel Value`)\n\nqa[qa %in% mask_values] <- NA\nLSTm <- mask(LST, qa)\nLSTm[LSTm<0] <- NA\nplot(LSTm)\n```\n\n# Overlay Raster to AOI\n\n```{r}\n# c(xmin = lng1, xmax = lng2, ymin = lat1, ymax = lat2)\nboundary <- raster(ymx=lat2, xmn=lng1, ymn=lat1, xmx=lng2)\nboundary <- projectExtent(boundary, LSTm@crs)\nlst2 <- crop(LST, boundary)\nplot(lst2)\n```\n\n# Bring in Buildings\n\n```{r}\ndb <- connect_postgres()\nq <- query_bounding_box(xmin = lng1, xmax = lng2, ymin = lat1, ymax = lat2)\nbuildings <- st_read(db, query = q)\nDBI::dbDisconnect(db)\n\n```\n\n\n```{r}\npal <- colorNumeric(c(\"#0C2C84\", \"#41B6C4\", \"#FFFFCC\"), values(lst2),\n  na.color = \"transparent\")\n\nleaflet(options = leafletOptions(minZoom = 13, maxZoom = 18)) |>\n  addTiles() |>\n  fitBounds(lng1, lat1, lng2, lat2) |>\n  setMaxBounds(lng1, lat1, lng2, lat2) |>\n  addPolygons(data = bbox) |>\n  addRasterImage(lst2, colors = pal, opacity = 0.5) %>%\n  addLegend(pal = pal, values = values(lst2),\n    title = \"Surface temp\") |>\n  addPolygons(data = buildings, fill = NA, color = \"black\", weight = 0.8)\n\n```\n\n## Aggregate Raster over Polygon\n\n```{r}\n# https://deepnote.com/@sookyan-siew/R-Aggregate-raster-to-polygon-data-10a3150c-e88d-4776-bae1-4b6dcb9e3916 \n# https://stackoverflow.com/questions/67717866/r-aggregating-raster-to-shapefile-polygons\n# Same projection\nlst3 <- projectRaster(lst2, crs = crs(buildings))\nplot(st_geometry(buildings))\nplot(lst3, add = TRUE)\nplot(st_geometry(buildings), add = TRUE)\navg_lst <- raster::extract(lst3, buildings, mean, na.rm = TRUE)\n\nbuildings$lst <- as.numeric(avg_lst)\n```\n\n```{r}\npal <- colorNumeric(c(\"#0C2C84\", \"#41B6C4\", \"#FFFFCC\"), buildings$lst,\n  na.color = \"transparent\")\n\nleaflet(options = leafletOptions(minZoom = 14, maxZoom = 17)) |>\n   addTiles(group = \"OSM (default)\") |>\n  addProviderTiles(providers$Stamen.Toner, group = \"Toner\") |>\n  addProviderTiles(providers$Stamen.TonerLite, group = \"Toner Lite\") |>\n  fitBounds(lng1, lat1, lng2, lat2) |>\n  setMaxBounds(lng1, lat1, lng2, lat2) |>\n  addPolygons(data = buildings, fillColor =  ~pal(lst), \n              color = \"black\", weight = 0, fillOpacity = 0.8,\n              label = ~round(lst,1),\n              popup = ~paste(\"<b>ID:</b>\", FEATCODE, \"<br>\", \"<b>LST:</b>\", round(lst,1))) |>\n   addLegend(pal = pal, values = buildings$lst,\n    title = \"Surface temp\")   |>\n  addLayersControl(\n    baseGroups = c(\"OSM (default)\", \"Toner\", \"Toner Lite\"),\n    options = layersControlOptions(collapsed = FALSE)\n  )\n\n\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"lst-by-building.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.179","editor":"visual","theme":"flatly","title":"What is Land Surface Temperature Building for a given site?","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}}}